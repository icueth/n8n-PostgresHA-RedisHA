#---------------------------------------------------------------------
# Redis HAProxy Configuration - Sentinel-Aware
# This proxy routes traffic to the current Redis master
# discovered via Redis Sentinel for automatic failover
#---------------------------------------------------------------------

global
    maxconn 4096
    log stdout format raw local0
    pidfile /var/run/haproxy.pid

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    option redispatch
    retries 3
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout check 5s

#---------------------------------------------------------------------
# Frontend - Listen for Redis connections
#---------------------------------------------------------------------
frontend redis_frontend
    bind *:${HAPROXY_PORT}
    default_backend redis_master

#---------------------------------------------------------------------
# Backend - Current Redis Master (discovered via Sentinel)
#---------------------------------------------------------------------
backend redis_master
    mode tcp
    option tcp-check
    
    # TCP check with Redis AUTH and PING
    tcp-check connect
    tcp-check send "AUTH ${REDIS_PASSWORD}\r\n"
    tcp-check expect string +OK
    tcp-check send "PING\r\n"
    tcp-check expect string +PONG
    tcp-check send "QUIT\r\n"
    tcp-check expect string +OK
    
    # Redis master server (dynamically updated)
    server redis-master ${REDIS_MASTER_HOST}:${REDIS_MASTER_PORT} check inter 2s fall 3 rise 2

#---------------------------------------------------------------------
# Stats page for monitoring
#---------------------------------------------------------------------
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
